---
title: "Building Tidy Data"
date: "`r Sys.Date()`"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo=TRUE)
```

# Overview

This notebook serves as reference for the tidying procedures used to prepare the
study data for analysis.

# Form the Data Frame

## Load the Raw Data

The raw data is loaded from a CSV file exported from Typeform.

```{r}
# Ignore the first two columns; they are junk.
df <- readr::read_csv('../data/dogs-and-children-survey.csv')

# Assert that the data set is 192 rows and 676 cols.
stopifnot(identical(dim(df)+0, c(192, 676)))
```

We update the data frame column names to be more friendly to work with during analysis.

```{r}
# Apply analysis friendly column names.
colnames(df) <- readr::read_csv('../data/column-names.csv') %>%
  dplyr::pull('readable')

# Peek at the data.
print(df, n=6)
```

# Drop Unnecessary Columns

We drop columns that will not be used in analysis.

```{r}
df <- df %>%
  select(-c(idx, id, start_date_utc, stage_date_utc, submit_date_utc, tags,
            ending))

# Assert size after dropping columns.
stopifnot(identical(dim(df)+0, c(192, 669)))
```

# Additional tidying + demographic summaries

Compute basic demographic summaries for EDA and to verify data structure. 

```{r}
# create a household identifier
# prefer network_id; fall back to owner_id
df <- df %>% 
  mutate(household_id = dplyr::coalesce(network_id, owner_id) %>% 
           stringr::str_to_lower() %>%
           stringr::str_trim())

# total number of responses
nrow(df)

# number of submissions per household
responses_per_household <- df %>%
  count(household_id, name = "n_submissions")

summary(responses_per_household$n_submissions)

# number of households with multiple submissions
responses_per_household %>%
  summarise(n_multi_submit = sum(n_submissions > 1))

# number of responses reporting at least one bite
df %>% 
  summarise(n_child_bite = sum(suppressWarnings(
    as.numeric(has_child_been_bitten)) > 0, na.rm = TRUE))
```

# Standardize Variables

Standardize household- and child-level demographic fields to consistent units.

```{r}
# Standardize child_cnt to numeric
# preserve raw data
df <- df %>% 
  mutate(child_cnt_raw = as.character(child_cnt)) %>% 
  mutate(child_cnt = case_when(
    str_to_lower(str_trim(child_cnt_raw)) %in% c("one") ~ 1,
    str_to_lower(str_trim(child_cnt_raw)) %in% c("two") ~ 2,
    str_to_lower(str_trim(child_cnt_raw)) %in% c("three") ~ 3,
    str_to_lower(str_trim(child_cnt_raw)) %in% c("four") ~ 4,
    str_to_lower(str_trim(child_cnt_raw)) %in% c("five") ~ 5, 
    TRUE ~suppressWarnings(as.numeric(child_cnt_raw))))

# Child_cnt checkpoint

# missing values
df %>% summarise(child_cnt_NA = sum(is.na(child_cnt)))
#distribution
df %>% count(child_cnt, sort = TRUE)
# summary statistics
summary(df$child_cnt)

# show failed to parse rows 
df %>% 
  filter(!is.na(child_cnt_raw), 
         str_trim(child_cnt_raw) != "", 
         is.na(child_cnt)) %>%
  select(child_cnt_raw) %>% 
  distinct()
```                     

# Save the Tidy Data    
    
Save the data to a file in the data directory using RDS format so that the data    
types are stored and the resulting file is compressed.    
    
```{r}
saveRDS(df, '../data/tidy.Rds')    
```  

# Display Session Info

```{r}
utils::sessionInfo()
```

# Bite flag 

```{r}
df <- df %>% mutate(
  incident_present = 
    !is.na(child_id) |
    !is.na(child_age_at_bite) |
    !is.na(desc_action_prior_to_bite) |
    if_any(starts_with("bite_location"), ~ suppressWarnings(as.numeric(.x)) == 1),
  bite_flag = case_when(has_child_been_bitten == 1 ~ TRUE,
                        incident_present ~ TRUE, 
                        has_child_been_bitten == 0 ~ FALSE, 
                        TRUE ~ NA),
  bite_flag_correct = coalesce(bite_flag, FALSE))
  
# sanity checks

df %>% 
  filter(household_id == "1926f89bc8") %>% 
  select(has_child_been_bitten, child_id, incident_present, bite_flag)

# how many bites
df %>% count(bite_flag, sort = TRUE)

# view NA
df %>% 
  filter(is.na(bite_flag)) %>% 
  select(household_id,
         has_child_been_bitten,
         incident_present,
         bite_flag)
  
df %>% count(bite_flag_correct, sort = TRUE)
df %>% count(has_child_been_bitten, bite_flag_correct)
```

```{r}
utils::sessionInfo()
```

## Variable Standardization: age, gender, multi-selection indicators (behavior)

# Standardize age into months 
```{r}
df %>%  count(child_age_at_bite, sort = TRUE) %>% 
  print(n = 50)

names(df)
"child_age_at_bite" %in% names(df)

str(df$child_age_at_bite)

# see all raw ages
df %>% count(child_age_at_bite, sort = TRUE) %>% 
  print(n = 100)

df <- df %>% mutate(age_raw = str_to_lower(str_trim(child_age_at_bite)),
                            age_num = readr::parse_number(age_raw),
                            child_age_months = case_when(
                              is.na(age_raw) | age_raw == "" ~ NA_real_,
                              str_detect(age_raw, "month|mo\\b") ~ age_num,
                              str_detect(age_raw, "year|yr\\b|yo\\b") ~ age_num * 12,
                              str_detect(age_raw, "^around\\s*[0-9]") ~ age_num * 12,
                              str_detect(age_raw, "^[0-9]+\\.[0-9]+$") ~ age_num * 12,
                              str_detect(age_raw, "^[0-9]+$") ~ age_num * 12,
                              TRUE ~ NA_real_))
# check child age as months
df %>%
  count(child_age_at_bite, child_age_months, sort = TRUE)

# add child age in years
df <- df %>%  mutate(child_age_years = if_else(
  is.na(child_age_months),
  NA_real_, child_age_months / 12))

# check columns
class(df$child_age_months) 
class(df$child_age_years)

# summary
df %>% select(child_age_months, child_age_years) %>% summary()

# drop helper columns 
df <- df %>% select(-age_raw, -age_num)
```

# Standardize child gender
```{r}
df <- df %>% mutate(child_sex_raw = str_to_lower(str_squish(child_sex)),
                            child_gender_std = case_when(is.na(child_sex_raw) | child_sex_raw == "" ~ NA_character_,
                                                               child_sex_raw %in% c("female", "f", "girl", "woman") ~ "Female",
                                                               child_sex_raw %in% c("male", "boy", "man") ~ "Male",
                                                               str_detect(child_sex_raw, "non[- ]?binary|nb\\b|genderqueer|trans|other") ~ "Other/Nonbinary",
                                                               str_detect(child_sex_raw, "prefer not|prefer not to say|decline") ~ "Prefer not to say",
                                                               TRUE ~ "Needs review"))
# check
df %>% count(child_gender_std, sort = TRUE)
# verify Needs review
df %>% filter(child_gender_std == "Needs review") %>% 
  count(child_sex_raw, sort = TRUE)

#remove helper columns
df <- df %>%  select(-child_sex_raw)
```

# confirm "child_age_months" -> numeric and "child_gender_std" -> character
```{r}
class(df$child_age_months) # numeric
class(df$child_gender_std)

``` 
# Standardize dog gender
```{r}
# inspect raw values 
df %>% count(dog_sex, sort = TRUE)

# create variable for sterilization
df <- df %>% mutate(dog_sex_raw = str_to_lower(str_squish(dog_sex)),
                    dog_sex_std = case_when(is.na(dog_sex_raw) | dog_sex_raw == "" ~ NA_character_,
                                            str_detect(dog_sex_raw, "\\bfemale\\b") ~ "Female",
                                            str_detect(dog_sex_raw, "\\bmale\\b") ~ "Male",
                                            TRUE ~ "Needs review"),
                    dog_neuter = case_when(is.na(dog_sex_raw) | dog_sex_raw == "" ~ NA,
                                           str_detect(dog_sex_raw, "spayed|neutered") ~ TRUE,
                                           dog_sex_raw %in% c("male", "female") ~ FALSE, 
                                           TRUE ~ NA))
                                           
# check
df %>%  count(dog_sex, dog_sex_std, dog_neuter, sort = TRUE)
class(df$dog_neuter) # logical
```

# Dog age standardization
```{r}
# inspect raw values
df %>% count(dog_age_at_bite, sort = TRUE)

df <- df %>% mutate(dog_age_raw = str_to_lower(str_squish(dog_age_at_bite)),
                    dog_age_raw = str_replace_all(dog_age_raw, "[^0-9\\.a-z\\s]", ""),
                    dog_age_num = readr::parse_number(dog_age_raw),
                    dog_age_months = case_when(is.na(dog_age_raw) | dog_age_raw == "" ~ NA_real_,
                                              str_detect(dog_age_raw, "month|mo\\b") ~ dog_age_num, # months
                                              str_detect(dog_age_raw, "year|yr\\b|yo\\b") ~ dog_age_num * 12, # years
                                              str_detect(dog_age_raw, "^[0-9]+(\\.[0-9]+)?$") ~ dog_age_num * 12,
                                              TRUE ~ NA_real_))
# check dog age in months
df %>%
  count(dog_age_at_bite, dog_age_months, sort = TRUE)

# create dog age in years
df <- df %>% mutate(dog_age_years = if_else(is.na(dog_age_months), NA_real_, dog_age_months / 12))

# check equivalence
df %>% select(dog_age_months, dog_age_years) %>% summary()
```

# end session

```{r}
utils::sessionInfo()
```

